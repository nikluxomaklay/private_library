# Feature Specification: Zettelkasten Notes System

**Feature Branch**: `003-zettelkasten-notes`
**Created**: 17 февраля 2026 г.
**Status**: Draft
**Input**: Система заметок Zettelkasten для частной библиотеки

## User Scenarios & Testing

### User Story 1 - Просмотр списка заметок (Priority: P1)

**Как пользователь системы**, я хочу видеть в боковом меню новый пункт «Notes». При переходе по ссылке я попадаю на список заметок.

Заметки отображаются в иерархическом виде с отступами для индикации зависимостей. Пагинация применяется только к верхнеуровневым заметкам (у которых нет родителя). Если у верхнеуровневой заметки есть дочерние, все они отображаются на текущей странице. Для каждой заметки отображаются индекс (ссылкой на детальную страницу) и тема.

**Why this priority**: Базовая навигация и просмотр существующих заметок — фундаментальная возможность системы. Без неё невозможно использование других функций.

**Independent Test**: Пользователь может перейти в раздел Notes из бокового меню и увидеть список всех заметок с правильной иерархией и пагинацией.

**Acceptance Scenarios**:

1. **Given** пользователь находится в системе, **When** пользователь кликает на пункт «Notes» в боковом меню, **Then** открывается страница списка заметок
2. **Given** пользователь находится на странице списка заметок, **When** заметки имеют иерархическую структуру, **Then** дочерние заметки отображаются с отступами относительно родительских
3. **Given** пользователь находится на странице списка заметок, **When** применяется пагинация, **Then** на странице отображаются только верхнеуровневые заметки согласно лимиту страницы, а все их дочерние заметки показываются полностью
4. **Given** пользователь находится на странице списка заметок, **When** пользователь видит заметку, **Then** отображаются индекс (как ссылка) и тема заметки

---

### User Story 2 - Просмотр детальной страницы заметки (Priority: P1)

**Как пользователь системы**, я хочу при переходе на детальную страницу заметки увидеть полную информацию о ней.

На детальной странице отображаются: индекс, тема, текст заметки, родительская заметка (если есть), связанные книжные издания с дополнительной информацией (в одной строке), ключевые слова, связанные заметки (индекс + тема), дата создания и дата обновления (в одной строке).

**Why this priority**: Детальный просмотр — вторая базовая функция после списка. Пользователь должен иметь возможность прочитать полную информацию о заметке.

**Independent Test**: Пользователь может кликнуть на индекс заметки в списке и увидеть детальную страницу со всей информацией.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице списка заметок, **When** пользователь кликает на индекс заметки, **Then** открывается детальная страница заметки
2. **Given** пользователь находится на детальной странице заметки, **When** заметка имеет родительскую заметку, **Then** отображается информация о родительской заметке
3. **Given** пользователь находится на детальной странице заметки, **When** заметка связана с книжными изданиями, **Then** отображаются книжные издания с дополнительной информацией в одной строке
4. **Given** пользователь находится на детальной странице заметки, **When** заметка имеет ключевые слова, **Then** отображаются все ключевые слова
5. **Given** пользователь находится на детальной странице заметки, **When** заметка имеет связанные заметки, **Then** отображаются индексы и темы связанных заметок
6. **Given** пользователь находится на детальной странице заметки, **When** заметка существует, **Then** отображаются дата создания и дата обновления в одной строке

---

### User Story 3 - Просмотр связанных заметок на странице книжного издания (Priority: P2)

**Как пользователь системы**, я хочу видеть связанные заметки на детальной странице книжного издания.

Заметки отображаются иерархически с использованием отступов для показа зависимостей между заметками.

**Why this priority**: Позволяет пользователю быстро увидеть все заметки, связанные с конкретным книжным изданием, что улучшает навигацию между связанными материалами.

**Independent Test**: На странице детального просмотра книжного издания отображается блок со связанными заметками в иерархическом виде.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице книжного издания, **When** с изданием связаны заметки, **Then** отображается блок со связанными заметками
2. **Given** пользователь находится на странице книжного издания, **When** связанные заметки имеют иерархическую структуру, **Then** заметки отображаются с отступами согласно уровню вложенности

---

### User Story 4 - Добавление заметки со страницы списка заметок (Priority: P2)

**Как пользователь системы**, я хочу иметь возможность создать новую заметку, находясь на странице списка заметок.

В блоке действий на странице списка заметок есть кнопка «New note», которая ведёт на страницу создания заметки.

**Страница создания заметки содержит**:
- Тема — строка (255 символов; обязательное поле)
- Текст заметки — текстовое поле (необязательное)
- Книжные издания — inline-список:
  - Каждый элемент состоит из двух полей:
    - Книжное издание — селектор с live-поиском и асинхронной загрузкой данных (необязательное)
    - Уточнения к книжному изданию — текстовое поле (необязательное; доступно для редактирования только если выбрано книжное издание)
  - Есть возможность добавить элемент в конец списка
  - Есть возможность убрать произвольный элемент списка
- Родительская заметка — селектор с live-поиском и асинхронной загрузкой данных (необязательное)
- Ключевые слова — селектор с live-поиском и асинхронной загрузкой данных (необязательное)

**Why this priority**: Создание заметок — основная функция системы. Возможность создания со страницы списка обеспечивает удобный рабочий процесс.

**Independent Test**: Пользователь может нажать кнопку «New note» на странице списка, заполнить форму и создать новую заметку.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице списка заметок, **When** пользователь кликает на кнопку «New note», **Then** открывается страница создания заметки
2. **Given** пользователь находится на странице создания заметки, **When** пользователь вводит тему и сохраняет заметку, **Then** заметка создаётся и отображается в списке
3. **Given** пользователь находится на странице создания заметки, **When** пользователь добавляет книжное издание через inline-список, **Then** может ввести уточнения к изданию
4. **Given** пользователь находится на странице создания заметки, **When** пользователь не выбрал книжное издание, **Then** поле «Уточнения к книжному изданию» недоступно для ввода
5. **Given** пользователь находится на странице создания заметки, **When** пользователь добавляет несколько элементов книжных изданий, **Then** может удалить любой элемент списка
6. **Given** пользователь находится на странице создания заметки, **When** пользователь выбирает родительскую заметку через селектор, **Then** связь сохраняется при создании
7. **Given** пользователь находится на странице создания заметки, **When** пользователь выбирает ключевые слова через селектор, **Then** слова сохраняются при создании

---

### User Story 5 - Добавление заметки со страницы книжного издания (Priority: P3)

**Как пользователь системы**, я хочу иметь возможность создать новую заметку, находясь на детальной странице книжного издания.

В блоке действий на странице книжного издания есть кнопка «New note», которая ведёт на страницу создания заметки с предзаполненным полем «Книжное издание».

**Why this priority**: Ускоряет создание заметок при работе с конкретным книжным изданием, автоматически устанавливая связь.

**Independent Test**: На странице книжного издания есть кнопка «New note», при нажатии на которую открывается форма создания с уже выбранным текущим изданием.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице книжного издания, **When** пользователь кликает на кнопку «New note», **Then** открывается страница создания заметки с предзаполненным полем «Книжное издание»
2. **Given** пользователь находится на странице создания заметки с предзаполненным книжным изданием, **When** пользователь сохраняет заметку, **Then** заметка создаётся со связью с указанным изданием

---

### User Story 6 - Добавление заметки со страницы другой заметки (Priority: P3)

**Как пользователь системы**, я хочу иметь возможность создать новую заметку, находясь на детальной странице другой заметки.

В блоке действий на странице заметки есть кнопка «New note», которая ведёт на страницу создания заметки с предзаполненными полями: «Родительская заметка», «Книжное издание» и «Ключевые слова». Поля «Тема» и «Текст заметки» остаются пустыми.

**Why this priority**: Облегчает создание связанных заметок в рамках одного контекста, наследуя связи от родительской заметки.

**Independent Test**: На странице заметки есть кнопка «New note», при нажатии на которую форма создания содержит данные текущей заметки в соответствующих полях.

**Acceptance Scenarios**:

1. **Given** пользователь находится на детальной странице заметки, **When** пользователь кликает на кнопку «New note», **Then** открывается страница создания заметки
2. **Given** пользователь находится на странице создания заметки, открытой из другой заметки, **When** форма загружена, **Then** поле «Родительская заметка» предзаполнено текущей заметкой
3. **Given** пользователь находится на странице создания заметки, открытой из другой заметки, **When** исходная заметка имеет связанные книжные издания, **Then** эти издания предзаполнены в форме
4. **Given** пользователь находится на странице создания заметки, открытой из другой заметки, **When** исходная заметка имеет ключевые слова, **Then** эти слова предзаполнены в форме
5. **Given** пользователь находится на странице создания заметки, открытой из другой заметки, **When** форма загружена, **Then** поля «Тема» и «Текст заметки» пустые

---

### User Story 7 - Изменение заметки (Priority: P2)

**Как пользователь системы**, я хочу иметь возможность изменить любую существующую заметку.

Страница изменения заметки аналогична странице создания и содержит те же поля:
- Тема — строка (255 символов; обязательное поле)
- Текст заметки — текстовое поле (необязательное)
- Книжные издания — inline-список (с возможностью добавления/удаления элементов)
- Родительская заметка — селектор с live-поиском и асинхронной загрузкой данных (необязательное)
- Ключевые слова — селектор с live-поиском и асинхронной загрузкой данных (необязательное)

**Why this priority**: Редактирование необходимо для поддержания актуальности заметок и исправления ошибок.

**Independent Test**: Пользователь может открыть существующую заметку на редактирование, изменить поля и сохранить изменения.

**Acceptance Scenarios**:

1. **Given** пользователь находится на детальной странице заметки, **When** пользователь инициирует редактирование, **Then** открывается страница редактирования с заполненными текущими данными
2. **Given** пользователь находится на странице редактирования заметки, **When** пользователь изменяет тему и сохраняет, **Then** изменения применяются
3. **Given** пользователь находится на странице редактирования заметки, **When** пользователь добавляет или удаляет книжные издания из inline-списка, **Then** изменения сохраняются
4. **Given** пользователь находится на странице редактирования заметки, **When** пользователь изменяет родительскую заметку, **Then** связь обновляется при сохранении
5. **Given** пользователь находится на странице редактирования заметки, **When** пользователь изменяет ключевые слова, **Then** изменения сохраняются

---

### User Story 8 - Удаление заметки (Priority: P2)

**Как пользователь системы**, я хочу иметь возможность удалить существующую заметку при условии, что у неё нет дочерних заметок.

В блоке действий на детальной странице заметки есть кнопка «Delete», которая ведёт на страницу подтверждения удаления. Система блокирует удаление, если у заметки есть дочерние заметки.

**Why this priority**: Удаление необходимо для очистки системы от ненужных заметок. Защита от удаления родительских заметок предотвращает случайную потерю данных.

**Independent Test**: Пользователь может удалить заметку без дочерних; попытка удалить заметку с дочерними блокируется.

**Acceptance Scenarios**:

1. **Given** пользователь находится на детальной странице заметки, **When** пользователь кликает на кнопку «Delete», **Then** открывается страница подтверждения удаления
2. **Given** пользователь находится на странице подтверждения удаления, **When** заметка не имеет дочерних заметок, **Then** пользователь может подтвердить удаление и заметка удаляется
3. **Given** пользователь находится на детальной странице заметки, **When** заметка имеет дочерние заметки, **When** пользователь кликает на кнопку «Delete», **Then** система блокирует удаление с сообщением об ошибке
4. **Given** пользователь удалил заметку без дочерних, **When** удаление подтверждено, **Then** пользователь перенаправляется на страницу списка заметок

---

### Edge Cases

- Что происходит при попытке удалить родительскую заметку, у которой есть дочерние? (Система должна блокировать удаление)
- Как система обрабатывает попытку создать циклическую зависимость в иерархии заметок? (Система должна блокировать создание цикла)
- Что происходит при попытке сохранить заметку без обязательного поля «Тема»? (Система должна показать ошибку валидации)
- Как система обрабатывает ситуацию, когда пользователь вводит текст в поле «Уточнения к книжному изданию» без выбора самого издания? (Поле должно быть недоступно)
- Что происходит при пагинации, если у верхнеуровневой заметки много дочерних? (Все дочерние отображаются на той же странице, что может превысить стандартный лимит)

## Requirements

### Functional Requirements

- **FR-001**: Система ДОЛЖНА предоставлять пункт меню «Notes» в боковой навигационной панели
- **FR-002**: Система ДОЛЖНА отображать список заметок в иерархическом виде с визуальными отступами для дочерних заметок
- **FR-003**: Система ДОЛЖНА применять пагинацию только к верхнеуровневым заметкам (без родителя) с тем же лимитом, что используется в других списках системы
- **FR-004**: Система ДОЛЖНА отображать все дочерние заметки на той же странице, что и их родительская заметка
- **FR-005**: Система ДОЛЖНА отображать индекс и тему для каждой заметки в списке
- **FR-006**: Система ДОЛЖНА делать индекс заметки ссылкой на детальную страницу
- **FR-007**: Система ДОЛЖНА отображать на детальной странице заметки: индекс, тему, текст, родительскую заметку, связанные книжные издания с уточнениями, ключевые слова, связанные заметки, даты создания и обновления
- **FR-008**: Система ДОЛЖНА отображать связанные книжные издания с дополнительной информацией в одной строке
- **FR-009**: Система ДОЛЖНА отображать дату создания и дату обновления в одной строке
- **FR-010**: Система ДОЛЖНА отображать связанные заметки на детальной странице книжного издания в иерархическом виде
- **FR-011**: Система ДОЛЖНА предоставлять кнопку «New note» на странице списка заметок
- **FR-012**: Система ДОЛЖНА предоставлять кнопку «New note» на странице книжного издания
- **FR-013**: Система ДОЛЖНА предоставлять кнопку «New note» на странице заметки
- **FR-014**: Система ДОЛЖНА предоставлять форму создания заметки с полями: тема (обязательное, до 255 символов), текст заметки (необязательное), книжные издания (inline-список), родительская заметка (необязательное), ключевые слова (необязательное)
- **FR-015**: Система ДОЛЖНА предоставлять inline-список книжных изданий с возможностью добавления элементов в конец списка
- **FR-016**: Система ДОЛЖНА предоставлять возможность удаления произвольного элемента из списка книжных изданий
- **FR-017**: Система ДОЛЖНА игнорировать при сохранении элементы списка, в которых не выбрано книжное издание
- **FR-018**: Система ДОЛЖНА делать поле «Уточнения к книжному изданию» доступным для редактирования только при выбранном книжном издании
- **FR-019**: Система ДОЛЖНА предоставлять селекторы с live-поиском и асинхронной загрузкой данных для полей: книжное издание, родительская заметка, ключевые слова
- **FR-020**: Система ДОЛЖНА предзаполнять поле «Книжное издание» при создании заметки со страницы книжного издания
- **FR-021**: Система ДОЛЖНА предзаполнять поля «Родительская заметка», «Книжное издание» и «Ключевые слова» при создании заметки со страницы другой заметки
- **FR-022**: Система ДОЛЖНА предоставлять форму редактирования заметки с аналогичной структурой полей как форма создания
- **FR-023**: Система ДОЛЖНА блокировать удаление родительской заметки, если у неё есть дочерние заметки
- **FR-024**: Система ДОЛЖНА проверять наличие циклических зависимостей при сохранении заметки и блокировать создание цикла с сообщением об ошибке
- **FR-025**: Система ДОЛЖНА генерировать индекс заметки автоматически при сохранении
- **FR-026**: Система ДОЛЖНА предоставлять кнопку «Delete» на детальной странице заметки
- **FR-027**: Система ДОЛЖНА предоставлять страницу подтверждения удаления заметки
- **FR-028**: Система ДОЛЖНА перенаправлять на страницу списка заметок после успешного удаления

### Key Entities

- **Заметка (Note)**: Основная единица системы Zettelkasten. Содержит тему, текст, индекс (генерируется автоматически), связи с родительской заметкой, другими заметками, книжными изданиями и ключевыми словами. Имеет даты создания и обновления.
- **Связь заметки с книжным изданием (NoteToBookEdition)**: Промежуточная сущность для связи заметок с книжными изданиями, содержащая дополнительную информацию (уточнения) к изданию в контексте заметки.
- **Ключевое слово (KeyWord)**: Тег или метка для категоризации и поиска заметок.
- **Книжное издание (BookEdition)**: Существующая сущность библиотеки, представляющая конкретное издание книги. Может быть связано с заметками.

## Success Criteria

### Measurable Outcomes

- **SC-001**: Пользователи могут создать новую заметку менее чем за 2 минуты
- **SC-002**: Пользователи могут найти и открыть любую заметку из списка менее чем за 3 клика
- **SC-003**: Система отображает список заметок с корректной иерархией в 100% случаев
- **SC-004**: Система предотвращает создание циклических зависимостей в 100% попыток
- **SC-005**: Пользователи могут успешно связать заметку с книжным изданием с первого раза без ошибок
- **SC-006**: Все связанные заметки на странице книжного издания отображаются корректно в 100% случаев
- **SC-007**: Пользователи могут отредактировать существующую заметку и сохранить изменения без потери данных в 100% случаев

## Clarifications

### Session 2026-02-17

- Q: Какие дополнительные поля должны предзаполняться при создании заметки из другой заметки? → A: Только 3 указанных поля (Родительская заметка, Книжное издание, Ключевые слова); Тема и Текст пустые
- Q: Как система должна обрабатывать элементы inline-списка, где не выбрано книжное издание? → A: Не сохранять элементы, где не выбрано книжное издание (игнорировать пустые)
- Q: Сколько верхнеуровневых заметок должно отображаться на одной странице? → A: Как на других списках (консистентность с существующими страницами)

## Assumptions

- Пользователи системы уже знакомы с базовой навигацией по приложению
- Индекс заметки генерируется по определённому алгоритму, который уже реализован в модели
- Селекторы с live-поиском работают аналогично существующей реализации для поля Publisher на странице создания Book edition
- Иерархия заметок поддерживает неограниченную глубину вложенности
- Система использует стандартные механизмы аутентификации и авторизации Django
